

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>createTransferRequestsForProcessed.py &mdash; FionaDocs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=33ab7645" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">
{
    "theme": "neutral",
    "themeVariables": {
        "primaryColor": "#ff0000"
    }
}
</script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
      <script src="../../_static/custom.js?v=e7cb14c9"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="createZipFileCmd.php" href="createZipFileCmd.html" />
    <link rel="prev" title="createTransferRequests.py" href="createTransferRequests.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            FionaDocs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../EndUser/index.html">END USER</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../EndUser/index.html#fiona-system">Fiona system</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../EndUser/index.html#research-information-system">Research Information System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../EndUser/index.html#new-project-creation-setup-and-access">New project: creation, setup and access</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#apply-for-a-new-project">Apply for a new project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#access-to-redcap-for-structured-data">Access to REDCap for structured data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#access-to-the-sectra-dma-forskning-research-pacs-viewer">Access to the “Sectra DMA Forskning” research PACS viewer</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../EndUser/index.html#submit-data-to-the-research-information-system">Submit data to the Research Information System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#how-to-add-image-data"><strong>How to add image data</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../EndUser/index.html#export-image-data-from-research-pacs">Export image data from research PACS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../EndUser/index.html#end-user-contract">End-user contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../EndUser/index.html#sensitive-data-projects">Sensitive Data Projects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#separation-of-sensitive-information-and-data">Separation of Sensitive Information and Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#randomization">Randomization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#e-consent">e-Consent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#automatic-data-exports-from-redcap">Automatic data exports from REDCap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#steps-at-the-end-of-a-redcap-project">Steps at the end of a REDCap project</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../EndUser/index.html#external-resources">External resources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#git-hub-repositories">Git-Hub Repositories</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../EndUser/index.html#redcap">REDCap</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ServerAdmin/index.html">ADMINISTRATION</a><ul class="simple">
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">ARCHITECTURE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../index.html#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#folder-and-file-structure">Folder and File structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#components">Components</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#system-setup-pipeline">System setup pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#data-flow">Data flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#data-storage-structure">Data Storage Structure</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FionaDocs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">ARCHITECTURE</a></li>
      <li class="breadcrumb-item active">createTransferRequestsForProcessed.py</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Architecture/scripts/createTransferRequestsForProcessed.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="createtransferrequestsforprocessed-py">
<h1>createTransferRequestsForProcessed.py<a class="headerlink" href="#createtransferrequestsforprocessed-py" title="Link to this heading"></a></h1>
<p>This script automatically detects processed medical imaging series that need to be forwarded to research PACS systems by identifying series with <code class="docutils literal notranslate"><span class="pre">StudyInstanceUIDs</span></code> that contain dots (indicating they’re new/processed data). It retrieves transfer requests from REDCap, modifies DICOM metadata to match original study identifiers, and forwards the data either directly to storage or through anonymization processes depending on the project type. The script also extracts structured report data for specific projects like <code class="docutils literal notranslate"><span class="pre">Transpara</span></code> studies and <code class="docutils literal notranslate"><span class="pre">NOPARK</span></code>.</p>
<p><strong>Related Files</strong></p>
<img src="../../_images/mermaid-5b957df7d5372c358e1c9450500d461cb7b9e382.png" alt="flowchart LR
 A[&quot;createTransferRequestsForProcessed.py&quot;]
 B[&quot;/home/processing/bin/extractDataFromTransparaSR.sh&quot;]
 C[&quot;/home/processing/bin/extractDataFromDaTQUANT.sh&quot;]
 D[&quot;/var/www/html/server/utils/s2m.sh&quot;]
 E[&quot;/home/processing/logs/extractDataFromTransparaSR.log&quot;]
 F[&quot;/home/processing/logs/extractDataFromDaTQUANT.log&quot;]
 G[&quot;/usr/bin/dcmodify&quot;]
 H[&quot;/usr/bin/storescu&quot;]
 I[&quot;Docker containers (dcmtk)&quot;]
 J[&quot;/data/site/raw/*/*.json&quot;]
 K[&quot;/data/site/raw/*/series_folders&quot;]

 J --&gt; |JSON metadata| A
 K --&gt; |DICOM series data| A
 A --&gt; |calls for Transpara projects| B
 A --&gt; |calls for NOPARK project| C
 A --&gt; |calls for anonymization| D
 A --&gt; |uses for DICOM modification| G
 A --&gt; |uses for direct PACS storage| H
 A --&gt; |uses for DICOM operations| I
 B --&gt; |processing logs| E
 C --&gt; |extraction logs| F

 %% Styling
 classDef inputFile fill:#e1f5fe
 classDef outputFile fill:#f3e5f5
 classDef mainScript fill:#fff3e0

 class A mainScript
 class B,C,D,G,H,I,J,K inputFile
 class E,F outputFile

 %% Styling
 classDef inputFile fill:#e1f5fe
 classDef outputFile fill:#f3e5f5
 classDef mainScript fill:#fff3e0" />
<p><strong>Data Flow Diagram</strong></p>
<img src="../../_images/mermaid-2fe924ffde769d9d81e8be3bc88c770a4f91b309.png" alt="flowchart LR
   A[&quot;createTransferRequestsForProcessed.py&quot;]
   B[&quot;/home/processing/bin/extractDataFromTransparaSR.sh&quot;]
   C[&quot;/home/processing/bin/extractDataFromDaTQUANT.sh&quot;]
   D[&quot;/var/www/html/server/utils/s2m.sh&quot;]
   E[&quot;/home/processing/logs/extractDataFromTransparaSR.log&quot;]
   F[&quot;/home/processing/logs/extractDataFromDaTQUANT.log&quot;]
   G[&quot;/usr/bin/dcmodify&quot;]
   H[&quot;/usr/bin/storescu&quot;]
   I[&quot;Docker containers (dcmtk)&quot;]
   J[&quot;/data/site/raw/*/*.json&quot;]
   K[&quot;/data/site/raw/*/series_folders&quot;]

   J --&gt; |JSON metadata| A
   K --&gt; |DICOM series data| A
   A --&gt; |calls for Transpara projects| B
   A --&gt; |calls for NOPARK project| C
   A --&gt; |calls for anonymization| D
   A --&gt; |uses for DICOM modification| G
   A --&gt; |uses for direct PACS storage| H
   A --&gt; |uses for DICOM operations| I
   B --&gt; |processing logs| E
   C --&gt; |extraction logs| F

   %% Styling
   classDef inputFile fill:#e1f5fe
   classDef outputFile fill:#f3e5f5
   classDef mainScript fill:#fff3e0

   class A mainScript
   class B,C,D,G,H,I,J,K inputFile
   class E,F outputFile

   %% Styling
   classDef inputFile fill:#e1f5fe
   classDef outputFile fill:#f3e5f5
   classDef mainScript fill:#fff3e0" />
<p>Data paths:</p>
<ul class="simple">
<li><dl class="simple">
<dt>Input Paths:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">/data/site/raw/*/</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Output Paths:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Research</span> <span class="pre">PACS</span> <span class="pre">server</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/home/processing/logs/</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Temporary</span> <span class="pre">directories</span> <span class="pre">(created</span> <span class="pre">dynamically)</span></code>.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<hr class="docutils" />
<section id="id1">
<h2>createTransferRequestsForProcessed.py<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>Detect if we have image series forwarded to FIONA
that belong to a study that already exists on the research PACS.
This happens if data is forwarded from the research PACS to a
workstation. The workstation procudes new image series and forwards
those to FIONA. There is no transfer request for them so they are not
automatically forwarded and Assign is not displaying them because
they have a study instance uid without a dot.</p>
<p>We want to forward them by first finding them (no dot in raw and dot
in series). Change their StudyInstanceUID to the incoming
one that has a transfer request. Send them to fiona so they will
show up in the correct folder, be detected as new incoming series for
existing study and auto forward using createTransferRequests.py.</p>
<ul class="simple">
<li><p>user: processing</p></li>
<li><p>depends-on:
- REDCap Incoming project</p></li>
<li><p>log-file:
- ${SERVERDIR}/logs/createTransferRequestsForProcessed.log</p></li>
<li><p>pid-file: ${SERVERDIR}/.pids/createTransferRequestsForProcessed.pid</p></li>
<li><p>start:
<a href="#id2"><span class="problematic" id="id3">*</span></a>/30 * * * * /usr/bin/flock -n /home/processing/.pids/createTransferRequestsForProcessed.pid /home/processing/bin/createTransferRequestsForProcessed.py &gt;&gt; /home/processing/logs/createTransferRequestsForProcessed.log 2&gt;&amp;1</p></li>
</ul>
<section id="notes">
<h3>Notes<a class="headerlink" href="#notes" title="Link to this heading"></a></h3>
<p>This script will create a SeriesInstanceUID compatible with FIONA’s anonymizer and use it to mark the new image series. If this identifier is changed the script needs to be updated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">:</span><span class="n">lineos</span><span class="p">:</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hashID</span><span class="p">(</span> <span class="n">SeriesInstanceUID</span> <span class="p">):</span>
    <span class="c1"># do the same operation that would be done by the anonymizer</span>
    <span class="c1"># get a safe string</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">SeriesInstanceUID</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">org_root</span> <span class="o">=</span> <span class="s2">&quot;1.3.6.1.4.1.45037&quot;</span>
    <span class="n">h</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">org_root</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">63</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="createTransferRequests.html" class="btn btn-neutral float-left" title="createTransferRequests.py" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="createZipFileCmd.html" class="btn btn-neutral float-right" title="createZipFileCmd.php" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Hauke Bartsch.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>