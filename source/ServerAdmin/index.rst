ADMINISTRATION
===============

**For:** IT administrators, DevOps

Setup / Installation
--------------------

FIONA can be deployed on a single virtual machine. For best performance we suggest to use a dedicated database system (MariaDB). At Helse Vest FIONA is setup as

.. code-block::
   {
     "architecture": "x86_64",
     "cpus": "16, Intel(R) Xeon(R) Gold 6154 @ 3.00GHz",
     "memory": "64GB",
     "partitions": { 
       "/": "200G",
       "/data": "1,000G",
       "/export": "2,000G",
       "/var/lib/docker/overlay2": "200G"
     }
   }

The database server running MariaDB should be able to scale based on the detailed logging information generated by REDCap for its 21 CFR Part 11 compliance. At our institutions the system is running with 200G main memory (5 years of operation) and an off system backup.


System maintenance
------------------

In the Helse Vest health region FIONA is running on an Ubuntu LTS server with automated updates (unattended-upgrades package). A reboot entry in cron ensures that kernel updates become effective on a weekly basis.

.. code-block::
   // default entries in /etc/apt.conf.d/50unattended-upgrades
   Unattended-Upgrade::Allowed-Origins {
      "${distro_id}:${distro_codename}";
      "${distro_id}:${distro_codename}-security";
      "${distro_id}ESMApps:${distro_codename}-apps-security";
      "${distro_id}ESM:${distro_codename}-infra-security";
   }

We have made good experiences with always upgrading to the lastest LTS release with ```do-release-upgrade```.

REDCap (Research Electronic Data Capture) is a database interface used by FIONA to store temporary information on the assignment of research identifies to clinical data (based on DICOM numeric IDs such as StudyInstanceUID). Updates of REDCap are frequent and may include security relevant updates. At regular intervals (suggested weekly) check the REDCap Control Center for "New REDCap versions are available to upgrade". Install these updates regularly using REDCap's web interface. REDCap will download and install the newest version on request of the admin user and perform any required updates to its SQL database table structures.


Yearly maintenance
^^^^^^^^^^^^^^^^^^

FIONA will use the database of REDCap continuously requesting information and updating entries. As REDCap is 
HIPPA compliant (21 CFR Part 11) it will log all such access in two databases that can grow over time to contain
millions of entries. We suggest to remove log entries generated by FIONA (user marked as "admin") to limit the
backup size for REDCap. The two tables used by REDCap are "redcap_log_view" and "redcap_log_event".

To remove entries regularly (once a year) we use code like the following (SQL):

.. code-block:: sql

   DELIMITER //
   CREATE OR REPLACE PROCEDURE redcap.deleteChunksLogEventWhatIsInIDS7()   
     BEGIN
       SELECT MIN(log_event_id) INTO @a FROM redcap_log_event;
       my_loop: LOOP
         SELECT log_event_id INTO @z FROM redcap_log_event WHERE log_event_id >= @a ORDER BY log_event_id LIMIT 1000,1;
         IF @z IS NULL THEN
            LEAVE my_loop;
         END IF;
         DELETE FROM redcap_log_event WHERE log_event_id >= @a AND log_event_id < @z AND project_id = "28" AND user = "admin";
         SET @a = @z;
         SELECT @a;
       END LOOP my_loop;
       DELETE FROM redcap_log_event WHERE log_event_id >= @a AND project_id = "28" AND user = "admin";
     END //
   
   DELIMITER ;
   
   CALL redcap.deleteChunksLogEventWhatIsInIDS7();

The above SQL procedure will chunk the operation based on the index log_event_id. This works even if the database already contains millions of log entries. Note that such removal only marks rows as empty. It does not reduce the size of the database without further optimization. But the removal of log entries will allow the system to re-use them for the continued operation.

The above code removes log events created by the admin user for a project ID "28". This corresponds on our system to a FIONA specific REDCap project called "WhatIsInIDS7". Further project_id's for which entries can be removed are project "Incoming", "Routing" and "ResearchProjects". You can lookup their numeric ids in REDCap's user interface.



